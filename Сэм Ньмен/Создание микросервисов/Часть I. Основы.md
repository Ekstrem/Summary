# Глава 1. Что такое микросервисы
## Понятие микросервисов
Микросервисы - подмножество Сервисно-ориентированной архитектуры, стоящияся вокруг предметной области бизнеса важнейшим из сввойств которой является возможность независимого развёртывания и сокрытие информации.

Ключевые понятия микросервисов:
- **Независимое развёртывания**. Напрямую влияет на то,насколько слабосвязанны сервисы (проверка практикой).
- **Моделирование вокруг предметной области бизнеса**. Следует отдавать приоритет сильной связанности бизенс-функциональности, нижели технической функциональности.
- **Контроль над ситуацией**. Единоличное владение микросервисом своими БД, кэшом, серкетами и т.п. 
- **Размер**. Уступает место способу декомпозиции.
- **Гибкость**. Организационная, техническая, масштабирование, надёжность.
- **Согласование архитектуры и структуры организации**. В идеале ценность должны создавать потоковые команды.
## Монолит
Совокупность архитектурных стилей, подразумевающих одну единицу развёртывания.
Виды:
- **Однопроцессный монолит**. Состовляет один процесс, хоть и может запускаться в нескольких экземплярах.
- **Модульный монолит**. Разновитдность одногопроцессного монолита, который разбит ну модулю но поставляется одним развёртыванием. На практике, одной из частых слабых сторон является связанность внутри БД, несоостветствующая границам разбиения логики.
- **Распределённый монолит**. Частный случай, который представляет вариант масштабирования через разделения данных. Впитывает в себя недостатки монолитов и распределённых систем.

_**Конфликт поставки**_ - состояние при работе над большим монолитным приложением, когда несколько команд могут конфликтовать за границы владения.

Простая топология развёртывания, упрощает доставку, тестирование мониторинг, процессы и т.д.

## Технологии развития
- Агрегирование логов и распределённая трассировка;
- Контейнеры и Kubernetes;
- Потоковая передача данных;
- Облако и бессервисный подход;

## Приемущества микросервисов
- **Технологическая неоднородность**. Возможность быстро производить исследование и апробирование новых технологий и подгодов.
- **Надёжность**. Автор применяет _термин_ переборок, совпадающих с концептуальными границами сервисов.
- **Масштабируемость**. Автор включает сюда гибкость использования ресурсов.
- **Простота развёртывания**
- **Согласованность рабочих процессов в организации**, т.е. решаются конфликты поставки.
- **Компонуемость**. Распределённый характер системы создаёт предпосылки к переиспользованию, плфатформизации.

## Слабые места микросервисов
- **Опыт разработчика** - усложнения работы (UX) разработчика, т.к. значительная часть работы переносится из локала в облако, что увеличивает циклы обратной связи.
- **Технологическая перегрузка**, как форма проявления технологического фетишизма.
- **Стоимость**. Микросервисы несут увеличение расходов на инфраструктуру, на взаимодействие команд, на разработку. И перевешивать эти расходы может лишь такая ситуация, когда низкая доступность системы приводит к недополученной прибыли.
- **Отчётность** меняет свою форму, тоже становится источником дополнительных расходов.
- **Мониторинг и устранение неполадок**.
- **Безопасность** - распределённый характер системы потенциально рождает уязвимость.
- **Тестирование**. Тестировать распределённые модули сложнее, но по мере роста, тестирование классическое будет давать всё меньше отдачи; потребуются новые формы тестирования (контрактное, на проде и т.п.).
- **Время ожидания**.
- **Согласованность**.

# Глава 2. Как моделировать микросревисы
Вопрос сцепленности (coupling) и связанности (cohesion) в контексте микросервисной архитектуры поднимает вопрос границ микросервисов, типа декомпозиции.
## 3 метрики качества границ:
### 1. Сокрытие информации
Сокрытие информации - Концепция разработанная Дэвидом Парнасом для поиска наиболее эффективного определения границ модулей. Подразумевает сокрытия максимального количества деталей за границами модуля.

_Автор считает микросервисные архитектуры формой модульной архитектуры, тем самым проводя диалектическую связь между разными формами._

Приемущества:
- **Ускорение времени разработки**. Возможность распараллелить работу.
- **Понятность**. Каждый модуль можно рассматривать отдельно, понимая его в себе.
- **Гибкость**. Возможность изменять модули в отдельности от других, комбинировать использование.

Другое описание связанности, предложенное Парнасом - связанность - это колличество знаний модулей друг о друге (качество в количество).

### 2. Сцепленность
Сцепленность - такое группирование функциональности, что вносимые изменения затрагивают только эту функциональность. Для микросервисной архитектуры следует стремиться к высокой сцепленности.

### 3. Связанность
Слабая связанность - такое группирование функциональности, когда изменение в одном модуле не выражаются изменениями в другом.

_В книге "Адаптивный код" была приведена количественная метрика связанности/сцепленности - сопряжённость._

### Взаимодействие связанности и сцепленности
Закон Ларри Константина: "структура стабильна, если сцепленность сильная, связанность слабая". Под стабильностью в данном законе понимается независимость жизненного цикла модуля (разработки, внедрения, тестирования и т.п.). 
Понятия сцепленности и связанности взаимно обусловленны. Сцепленность оперделяет отношения между объектами в границах, а связанность через границу.

_Сопряжённость определяет саму границу._

При этом нет верного понимания границ сопряжённости и связанности, т.к. нестатичность требований в движении приводит к смене границ.

## Типы связанности
Возникновение связнности - неизбежность, которой следует управлять, сводить её к минимуму. Автор предлагает использовать техники структурированного программирования для определения возможных типов связанности, предлагая их от большей связанности к меньшей, соответственно от более желательной к менее желательной: предметная, сквозная, общая, по содержимому.

### Предметная связанность
Доменная связь описывает ситуацию, когда одной микрослужбе приходится взаимодействовать с другой, поскольку первому требуется использовать функциональность, предоставляемую второй микрослужбой. При том что предметная связанность считается наиболее слабой, иногда могут возникать сложности, проявляемые в формах связи. Одна из них - временная связь - ситуациця когда для выполнения операции в одной микрослужбе, нужна устойчивая работа другой (например, дозапрос параметров в одном из микросервисов). Временная связь может отрицательно сказаться на масштабировании.

### Сквозная связанность
Сквозная связанность описывает ситуацию, когда одна микрослужба взаимодействует с другой, только потому, что данные нужны третьему микросервису, находящемуся дальше по потоку. Одна из проблемных связей, которая заставляет микросервису знать как работает удалённый от него микросервис. Основная проблема данного типа - изменения в модуле ниже по потоку могут привести к значительным изменениям выше по потоку.
Связанность подобного рода можно исправить несколькими способами:
1. Микрослужба-потребитель напрямую получает данные у нужного микросервиса. Однако в ряде случаев, из-за необходимости оркестрации бизнес-процесса, такое действие может быть чревато.
2. Оставить в контракте между первыми двумя сервисами необходимые данные вместо контракта.
3. SLOB контракта между - микрослужбами один и два в сторону последнего микросервиса.

### Общая связанность
Описывает ситуацию, когда две микрослужбы совместно управляют одним и тем же набором данных.
Для устранения можно:
1. Делегировать управление только одной микрослужбе
2. Сделать простую микрослужбу с CRUD-интерфейсом для управления этим набором данных.

### Связанность по содержимому
Представляет такую ситуацию, когда одна из микрослужб может напрямую работать с набором данных другой. Представляет собой частный случай общей связанности. В этом случае совершенно теряется контроль за изменением данных, в силу отсутствия сокрытия информации для внешних модулей.

## Предметно-ориентированное проектирование
Автор ссылается на Эванса, классическое понимание предметно-ориентированного проектирования.
### Общеупотребимый язык
Автор приводит свой жизненный опыт частного применения корпоративного соглашения о модели данных (то что в нашей стране называют КМД) - применения общей модели усложнило код, из системы при этом трудно извлечь стоение самой предметки. После перехода на общеупотребимый язык, команде стало значительно проще.

### Агрегат
Совокупность имеющая состояния, идентичность, жизненный цикл которым можно управлять, и представляет как правило объекты реального мира.

### Ограниченные контексты
Автор рассматривает понятие, как средство управление сокрытием информации и сцепленностью.
В одном ограниченном контексте может быть один или несколько агрегатов. ОК могут содержать скрытые и общедоступные модели.

### Аргументы в пользу DDD
1. Сокрытие информации по средством ограниченных контекстов позволяет получить стабильные границы микросервиса.
2. Акцент на общеупотребимом языке позволяет применять подход API First, что влиет на связанность, а соответственно на границы.
3. Изменения бизнеса чаще отражаются в рамках ограниченного контекста, что снижает связанность.
4. Улучшение коммуникации, общего понимания бизнеса и его процессов.

### Альтернативы DDD
- **Волатильность**. Подход основан на том какие части меняются, как часто - бимодальность ИТ-модель - системы которые меняются редко, системы которые меняются часто.. Подход не может быть базовым, для тех случаев, когда необходимо масштабирование.
- **Данные**. Основан на необходимости разделять данные из-за внешних ограничений (GDPR, PCI DSS).
- **Технологии**. Основан на разности технологических стеков.
- **Организационный подход**. _Самоорганизация определяет архитектуру. Определение границ сервисов - ключевая часть процесса принятия решений_. Совместное владение микросервисами сопряжено с большими трудностями, поэтому следует определять конкретных владельцев, если необходимо, менять орг.структуру для такой возможности. Автор рекомендует избегать горизонтального расслоения систем.
- **Смешивание моделей и исключений**. Автор изложил несколько подходов, и подчёркивает, что в силу обстоятельств иногда приходится смешивать подходы. Кроме того, предостеригает от навязанных решений, указывая на то что если кто-то настаивает на определённом, то это интересы этого человека.

# Глава 3. Разделение монолита на части
Автор делает упор, на важности понимания необходимости микросервисов, что результат ни в коем случае нельзя подменять деятельности. Т.о. выбор микросервисной архитектуры крайний случай. Ещё раз подсвечивается польза монолитной архитектуры и ожидаемые трудности от внедрения микросервисной архитектуры. Ньюман рекомендукт начинающим инженерам не планировать массовые изменения, а отделять несколько функций, оценивать влияние.

При выделении первых функций из монолита, выбор выделяемой функции будет продиктован балансом между простатой выделения и выгодой. Предлается поэтапная работа для выделения первых микросервисов, два подхода к выделению: сначала код и сначала данные.

## Шаблоны выделения микросервисов
_Шаблоны выделения соответствуют книге Разделение монолита на микросервисы._
### Душитель
Заключается в фасадировании монолита, информационные потоки перенаправляются на микросервис. Не требует изменений в монолите
### Параллельное выполнение
Легаси и микросервис вместе выполняют работу, результат сравнивается. Подробнее будет обозрено в главе 8.
### Шаблон переключаемых функций
Частный случай шаблона душитель, когда есть возможность переключить потоки данных с монолита на микросервисы.

## Проблемы декомпозиции
- **Производительность**. Возможно падение производительности, когда в результате декомпозиции данные фрагментируются, но для ряда задач требуется их консолидация (отчёты).
- **Согласованность**. Аналогичная проблема
- **Транзакции**. В монолитах обычно координируются на уровне БД, в микросервисах возникает необходимость делать это вручную.
- **Инструментарий**. Автор считает, что есть сложность с внесением изменений в структуру БД, в силу ограниченности инструментария.
- **База данных отчётов**. Необходимость делать отчёты, может привести к созданию реплики БД, что приводит к наружению принципа сокрытия информации.

# Глава 4. Стили взаимодействия микросервисов
Отличия внутрипроцессных (внутри одного процесса) и внешнепроцессных (процессы соеденённые сетью) взаимодействий:
- производительность;
- изменение интерфейсов;
- обработка ошибок.
Виды отказов ("Распределённые системы" Таненбаум и Стин):
- _аварийный отказ_;
- _пропуск при отказе_;
- _сбой синхронизации_;
- _ошибки ответа_;
- _произвольный отказ_;

## Стили взаимодействия микросервисов
### Шаблон: Синхронная блокировка
Микросервис выполняет вызов другого микросервиса, блокирует операцию в ожидании ответа. Часто оказывается взаимодействием "запрос-ответ".
(+) Данному типу взаимодействия имманентно использование транзакций на уровне базы данных, что снижает комплексную сложность системы и бизнес-сценариев.
(-) Двухсторонняя **_временная связанность_**. В случае недоступности одного второго микросервиса требуется компенсирующие воздействие.
(-) Система становится более уязвима для каскадных проблем, вызыванных сбоями.
Применение данного шаблона подходит в простых система, с малым количеством вложенных вызовов. Также стоит рассмотреть в начале миграции с монолита.

### Шаблон: Асинхронная неблокирующая связь
Микросервис может выполнять вызов другого микросервиса независимо от того принят ответ или нет.
Три варианта:
- _Связь через общие данные_;
- _Запрос-ответ_;
- _Событийное взаимодействие_.
(+) Микросервисы временно теряют связанность, что хорошо при проблемах и сбоях.
(+) Хорошо подходит для протяжённых во времени или ресурсоёмких операций.
(-) Сложность реализации, тестирования.
Шаблон стоит применять в длительных процессах, процессах с длинными цепочками вызовов.

#### Шаблон: Связь через общие данные
Взаимодействие через общий источник данных. Требует механизма обнаружения изменений, например, _pooling_.
(+) Хорошо сочетается с большим объёмом данных (пакетные данные).
(-) CDC механизм трудно настроить на небольшой отклик.
(-) Общее хранилище рождает **_общую связанность_**.
(-) Надёжность связи зависит в т.ч. от надёжности хранилища.
Подходит для сценариев где есть существенные ограничения по применению технологий, есть потребность в обработке очень больших объёмов данных.

### Шаблон: Запрос-ответ
Микросервис выполняет вызов другого микросервиса отправляя запрос, ожидая ответ информирующий о результате.
Подходит для случаев где нужно дождаться ответа, провести оркестрацию процесса.

### Шаблон: Событийный стиль
Микросервисы порождают собития, другие микросервисы потребляют их. Микросервис-поставщик событий не владеет информацией о потребителях.
Событие - констатация
(+) Предметная связанность.
(+) Такая система более тяготеет к хореографии.
(-) Высокая сложность системы (порог вхождения).
События могут содержать только идентификатор сущности, могут более детальную информацию.
Подход больше подходит там, где требуется низкая связанность, расслоение системы.







